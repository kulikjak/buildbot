name: CI
on:
  push:
    branches:
    - test-github-actions
  pull_request:
    branches:
    - test-github-actions

jobs:
  db:
    name: DB / ${{ matrix.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: MySQL 5
            database: mysql:5
            connection: 'mysql+mysqldb://buildbot:buildbot@127.0.0.1:3306/bbtest?storage_engine=InnoDB'
            check: mysqladmin ping

    env:
      BUILDBOT_TEST_DB_URL: ${{ matrix.connection }}
      BUILDBOT_TEST_PROXY_CONNECTION_STRING: 'tcp:127.0.0.1:8888'

    services:
      database:
        image: ${{ matrix.database }}
        env:
          MYSQL_USER: buildbot
          MYSQL_PASSWORD: buildbot
          MYSQL_DATABASE: bbtest
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          POSTGRES_USER: buildbot
          POSTGRES_PASSWORD: buildbot
          POSTGRES_DB: bbtest
        ports:
          - '3306:3306'
          - '5432:5432'
        options: --health-cmd "${{ matrix.check }}" --health-interval 10s --health-timeout 5s --health-retries 10

      proxy:
        image: ajoergensen/tinyproxy:latest
        env:
          ALLOWED: '0.0.0.0/0'
          CONNECT_PORTS: ' '
        ports:
          - '8888:8888'
          - '9000:127.0.0.1'

    steps:
      - name: Dump the config file
        run: docker exec -i $(docker ps --latest --quiet) cat /etc/tinyproxy/tinyproxy.conf

      - uses: actions/checkout@v2

      - run: sudo apt-get install aspell aspell-en enchant iamerican ispell

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Cache pip
        uses: actions/cache@v2
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-ci.txt', 'requirements-cidb.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - run: pip install -U pip
      - run: pip install -r requirements-ci.txt -r requirements-cidb.txt

      # run real db tests under coverage to have several merging coverage report
      # https://github.com/codecov/support/wiki/Merging-Reports
      - run: coverage run --rcfile=.coveragerc $(which trial) --reporter=text --rterrors buildbot.test buildbot_worker.test
        timeout-minutes: 2

      - name: Dump docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@v1
        with:
          images: ajoergensen/tinyproxy

      #- name: Dump the access log
      #  if: failure()
      #  run: docker exec -i $(docker ps --latest --quiet) cat /var/log/squid/access.log

      #- name: Dump the config file
      #  if: failure()
      #  run: docker exec -i $(docker ps --latest --quiet) cat /etc/squid/squid.conf
